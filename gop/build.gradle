/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java application project to get you started.
 * For more details take a look at the 'Building Java & JVM projects' chapter in the Gradle
 * User Manual available at https://docs.gradle.org/7.3/userguide/building_java_projects.html
 */

plugins {
    // Apply the application plugin to add support for building a CLI application in Java.
    id 'application'
    id 'com.gradleup.shadow' version '9.3.1'
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

def releaseVersion = (project.findProperty('releaseVersion') ?: '1.0.0').toString()
version = releaseVersion

def toInstallerVersion = { String v ->
    def cleaned = v.replaceAll('[^0-9.]', '')
    if (!cleaned) {
        return '1.0.0'
    }
    def parts = cleaned.tokenize('.').take(3).collect { it.isInteger() ? it : '0' }
    while (parts.size() < 3) {
        parts.add('0')
    }
    parts.join('.')
}

def installerVersion = toInstallerVersion(releaseVersion)

repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
}

dependencies {
    // Use JUnit Jupiter for testing.
    testImplementation platform('org.junit:junit-bom:5.14.2')
    testImplementation 'org.junit.jupiter:junit-jupiter'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'

    // This dependency is used by the application.
    // implementation'com.google.guava:guava:30.1.1-jre'

    implementation 'org.apache.httpcomponents.client5:httpclient5:5.6'
    implementation 'com.google.code.gson:gson:2.13.2'
    implementation 'com.mysql:mysql-connector-j:9.6.0'
    implementation 'org.postgresql:postgresql:42.7.9'
    implementation 'org.mariadb.jdbc:mariadb-java-client:3.5.7'
    implementation fileTree(dir: 'lib', include: '*.jar')
}

application {
    // Define the main class for the application.
    mainClass = 'app.Gop'
}

tasks.named('shadowJar') {
    archiveClassifier = 'all'
}

tasks.withType(Jar).configureEach {
    manifest {
        attributes(
            'Implementation-Title': 'gop',
            'Implementation-Version': project.version.toString()
        )
    }
}

def shadowJarFileName = tasks.named('shadowJar').get().archiveFileName.get()

def jpackageExecutable = {
    javaToolchains.launcherFor {
        languageVersion = JavaLanguageVersion.of(21)
    }.get().metadata.installationPath.file("bin/jpackage").asFile
}

def packagingResourcesDir = layout.projectDirectory.dir("packaging/resources").asFile
def jpackageResourceArgs = packagingResourcesDir.exists()
        ? ['--resource-dir', packagingResourcesDir.absolutePath]
        : []

tasks.register('jpackageAppImage', Exec) {
    dependsOn 'shadowJar'
    def outputDir = layout.buildDirectory.dir("jpackage").get().asFile
    doFirst {
        outputDir.mkdirs()
        def appImage = new File(outputDir, "gop.app")
        if (appImage.exists()) {
            appImage.deleteDir()
        }
    }
    commandLine(
        jpackageExecutable(),
        '--type', 'app-image',
        '--input', layout.buildDirectory.dir("libs").get().asFile.absolutePath,
        '--dest', outputDir.absolutePath,
        '--name', 'gop',
        '--main-jar', shadowJarFileName,
        '--main-class', application.mainClass.get()
    )
    if (!jpackageResourceArgs.isEmpty()) {
        args jpackageResourceArgs
    }
}

def jpackageCommand = { String type, File outputDir ->
    [
        jpackageExecutable(),
        '--type', type,
        '--input', layout.buildDirectory.dir("libs").get().asFile.absolutePath,
        '--dest', outputDir.absolutePath,
        '--name', 'gop',
        '--main-jar', shadowJarFileName,
        '--main-class', application.mainClass.get(),
        '--vendor', 'exgoya',
        '--description', 'Database monitoring console tool'
    ] + jpackageResourceArgs
}

def requireOs = { String label, boolean ok ->
    if (!ok) {
        throw new GradleException("jpackage '${label}' must be run on the target OS.")
    }
}

tasks.register('jpackageDmg', Exec) {
    dependsOn 'shadowJar'
    def outputDir = layout.buildDirectory.dir("jpackage").get().asFile
    doFirst {
        outputDir.mkdirs()
        requireOs('dmg', org.gradle.internal.os.OperatingSystem.current().isMacOsX())
    }
    commandLine(jpackageCommand('dmg', outputDir) + [
        '--app-version', releaseVersion,
        '--mac-app-category', 'public.app-category.developer-tools',
        '--mac-package-identifier', 'com.exgoya.gop'
    ])
}

tasks.register('jpackagePkg', Exec) {
    dependsOn 'shadowJar'
    def outputDir = layout.buildDirectory.dir("jpackage").get().asFile
    doFirst {
        outputDir.mkdirs()
        requireOs('pkg', org.gradle.internal.os.OperatingSystem.current().isMacOsX())
    }
    commandLine(jpackageCommand('pkg', outputDir) + [
        '--app-version', releaseVersion,
        '--mac-app-category', 'public.app-category.developer-tools',
        '--mac-package-identifier', 'com.exgoya.gop'
    ])
}

tasks.register('jpackageDeb', Exec) {
    dependsOn 'shadowJar'
    def outputDir = layout.buildDirectory.dir("jpackage").get().asFile
    doFirst {
        outputDir.mkdirs()
        requireOs('deb', org.gradle.internal.os.OperatingSystem.current().isLinux())
    }
    commandLine(jpackageCommand('deb', outputDir) + [
        '--app-version', releaseVersion,
        '--linux-app-category', 'Development;System;'
    ])
}

tasks.register('jpackageRpm', Exec) {
    dependsOn 'shadowJar'
    def outputDir = layout.buildDirectory.dir("jpackage").get().asFile
    doFirst {
        outputDir.mkdirs()
        requireOs('rpm', org.gradle.internal.os.OperatingSystem.current().isLinux())
    }
    commandLine(jpackageCommand('rpm', outputDir) + [
        '--app-version', releaseVersion,
        '--linux-app-category', 'Development;System;'
    ])
}

tasks.register('jpackageMsi', Exec) {
    dependsOn 'shadowJar'
    def outputDir = layout.buildDirectory.dir("jpackage").get().asFile
    doFirst {
        outputDir.mkdirs()
        requireOs('msi', org.gradle.internal.os.OperatingSystem.current().isWindows())
    }
    commandLine(jpackageCommand('msi', outputDir) + [
        '--app-version', installerVersion
    ])
}

tasks.register('jpackageWindows') {
    dependsOn 'jpackageMsi'
}

tasks.register('jpackageMac') {
    dependsOn 'jpackageDmg', 'jpackagePkg'
}

tasks.register('jpackageLinux') {
    dependsOn 'jpackageDeb', 'jpackageRpm'
}

tasks.named('build') {
    dependsOn 'shadowJar', 'shadowDistZip', 'jpackageAppImage'
}

tasks.named('test') {
    // Use JUnit Platform for unit tests.
    useJUnitPlatform()
}

distributions {
    main {
        contents {
            if (packagingResourcesDir.exists()) {
                from(packagingResourcesDir)
            }
        }
    }
}
